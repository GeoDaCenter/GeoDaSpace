\documentclass{article}
\title{GMM procedure to estimate a spatial error model}
\author{Daniel Arribas-Bel, David Folch}
\usepackage{amsmath}
\begin{document}
\maketitle
\section{The model}
The initial model we are considering here is the following form:

\begin{equation}
    y = X \beta + u
    \label{model1}
\end{equation}

where the error $u$ is expressed as follows:
\begin{equation}
    u = \lambda W u + \varepsilon
    \label{model2}
\end{equation}

\paragraph{Heteroskedasticity assumption}
The innovations $\{\varepsilon_i: 1 \leq i \leq n\}$ satisfy
$E\varepsilon_i=0$, $E(\varepsilon_i^2) = \sigma_i^2$.

\section{Moment conditions}
Consider the following population moment conditions:

\begin{eqnarray}
    n^{-1} E \bar{\varepsilon}' \bar{\varepsilon} & = & n^{-1}
    tr\{ W [diag_{i=1}^n (E\varepsilon_i^2)] W' \} \\
    n^{-1} E \bar{\varepsilon}' \varepsilon & = & 0 \nonumber
    \label{moments}
\end{eqnarray}

We can operate on the sample analogues by ignoring the expectations
($E$). 

The first line may be rearranged in the following fashion:

%First part
\begin{align}
%n^{-1} \bar\varepsilon'\bar\varepsilon = n^{-1} tr\{W[diag_{i=1}^n(\varepsilon_i^2)]W'\} \\
n^{-1} \left[\bar\varepsilon'\bar\varepsilon - tr\{W[diag_{i=1}^n(\varepsilon_i^2)]W'\}\right] = 0
\label{l1}
\end{align}


The first term within the parenthesis of eq. \ref{l1} may be developed as
follows:

\begin{align}
\bar\varepsilon'\bar\varepsilon &= \varepsilon' W'W \varepsilon \\ 
&= (u - \lambda u_L)' W'W (u - \lambda u_L) \\
&= (u' - \lambda u_L') W'W (u - \lambda u_L) \\
&= (u_L' - \lambda u_{LL}') (u_L - \lambda u_{LL}) \\
&= u_L' u_L - \lambda u_L' u_{LL} - \lambda u_{LL}' u_L + \lambda^2 u_{LL}'u_{LL} \\
&= u_L' u_L - \lambda (u_L' u_{LL} + u_{LL}' u_L) + \lambda^2 u_{LL}'u_{LL} \\
&= u_L' u_L - \lambda (u_L'u_{LL} + u_L' u_{LL}) + \lambda^2 u_{LL}'u_{LL} \\
&= u_L' u_L - \lambda 2 u_L' u_{LL} + \lambda^2 u_{LL}'u_{LL}
\end{align}


The second term within the parenthesis of eq. \ref{l1} (the diagonal matrix)
can also be worked out as follows: 

\begin{align}
tr\{W[diag_{i=1}^n(\varepsilon_i^2)]W'\} &= tr\{[diag_{i=1}^n(\varepsilon_i^2)]W'W\} \\
&= tr\{diag_{i=1}^n(\varepsilon_i^2) \mbox{  } diag_{i=1}^n(w_{\cdot i}' w_{\cdot i})\} \\
&= tr\{diag_{i=1}^n((u_i - \lambda u_{Li})^2) \mbox{  } diag_{i=1}^n(w_{\cdot i}' w_{\cdot i})\} \\
&= tr\{diag_{i=1}^n(u_i^2 - 2 \lambda u_i u_{Li} + \lambda^2 u_{Li}^2 ) \mbox{  } diag_{i=1}^n(w_{\cdot i}' w_{\cdot i})\} \\
&= \sum_{i=1}^n\left\{(u_i^2 - 2 \lambda u_i u_{Li} + \lambda^2 u_{Li}^2 ) \sum_{j=1}^n(w_{ji}^2)\right\} \\
&= \sum_{i=1}^n\left\{(u_i^2 - 2 \lambda u_i u_{Li} + \lambda^2 u_{Li}^2 ) D_i\right\} 
\end{align}
where $D_i = \sum_{j=1}^n(w_{ji}^2)$.
\begin{align}
&= \sum_{i=1}^n\left\{D_i u_i^2 - 2 \lambda D_i u_i u_{Li} + \lambda^2 D_i u_{Li}^2 \right\} \\
&= \sum_{i=1}^n D_i u_i^2 - \lambda \sum_{i=1}^n 2D_i u_i u_{Li} + \lambda^2
\sum_{i=1}^n D_i u_{Li}^2 
\end{align}


If we now glue both together, the first line of eq. \ref{moments} may be
expressed as:
\begin{align}
n^{-1} \left[
u_L' u_L - \lambda 2 u_L' u_{LL} + \lambda^2 u_{LL}'u_{LL}  -    
\sum_{i=1}^n D_i u_i^2 + \lambda \sum_{i=1}^n 2D_i u_i u_{Li} - \lambda^2
\sum_{i=1}^n D_i u_{Li}^2  
\right] = 0\\n^{-1} \left[
\left\{u_L' u_L  - \sum_{i=1}^n D_i u_i^2\right\} + \lambda
\left\{\sum_{i=1}^n 2(D_i u_i u_{Li} - u_L' u_{LL})\right\} +
\lambda^2 \left\{u_{LL}'u_{LL} - \sum_{i=1}^n D_i u_{Li}^2\right\}  
\right] = 0
\end{align}



Equally, we can reorganize the second equation:

\begin{eqnarray}
    n^{-1} \bar{\varepsilon}' \varepsilon & = & n^{-1} \left[ \varepsilon'W'\varepsilon
    \right] \\
    & = & n^{-1} \left[ (u - \lambda u_L)' W' (u - \lambda u_L) \right] \\
    & = & n^{-1} \left[ (u' - \lambda u_L') W' (u - \lambda u_L) \right] \\
    & = & n^{-1} \left[ (u'W' - \lambda u_L'W')(u-\lambda u_L) \right] \\
    & = & n^{-1} \left[ u'W'u - \lambda u' W' u_L - \lambda u_L'W'u + \lambda^2 u_L'W'u_L \right] \\
    & = & n^{-1} \left[ u_L' u - \lambda u_L' u_L - \lambda u_{LL}' u + \lambda^2u_{LL}' u_L \right] \\
    & = & n^{-1} \left[ u_L' u - \lambda (u_L'u_L +u_{LL}'u) + \lambda^2
    u_{LL}'u_L\right]
\end{eqnarray}

In light of the previous operations, we may now write eq. \ref{moments} as a
system of equations:

% System of equations

\begin{equation}
\left[ \begin{array}{c}
    n^{-1} u_L' u_L  - \sum_{i=1}^n D_i u_i^2 \\
    n^{-1} u_L' u \\
\end{array} \right]
+
B
\left[ \begin{array}{c}
    \lambda \\
    \lambda^2 \\
\end{array} \right]
=
\left[ \begin{array}{c}
    0 \\
    0 \\
\end{array} \right]
\label{syseq}
\end{equation}

where:

\[
B
=
\left[ \begin{array}{cc}
    n^{-1} \sum_{i=1}^n 2(D_i u_i u_{Li} - u_L' u_{LL}) & n^{-1}
    u_{LL}'u_{LL} - \sum_{i=1}^n D_i u_{Li}^2\\
    n^{-1} (u_L'u_L +u_{LL}'u) & n^{-1} u_{LL}'u_L \\
\end{array} \right]
\]

or:
\[
B
=n^{-1}
\left[ \begin{array}{cc}
    2 (\sum_{i=1}^nD_i u_i u_{Li} - u_L' u_{LL}) &
    u_{LL}'u_{LL} - \sum_{i=1}^n D_i u_{Li}^2\\
    (u_L'u_L +u_{LL}'u) & u_{LL}'u_L \\
\end{array} \right]
\]

\section{Estimation procedure}
The method to estimate this model is composed by
two main steps, which are subdivided into smaller stages.

\subsection{Non-transformed model}
\label{s1}
In this section, a GMM procedure is used to obtain a consistent and efficient
estimator for $\lambda$ that will be used in section \ref{s2} to perform a
spatial Cochrane-Orcutt transformation and estimate the new model.

\subsubsection{OLS Estimator}
In the first step, we estimate $\beta$ from eq. \ref{model1} by standard OLS.
The estimator is:

\begin{equation}
    \tilde{\beta} = (X'X)^{-1}X'y
    \label{ols1}
\end{equation}

\subsubsection{GMM Estimator of $\lambda$}
In light of  the previous result, the OLS residuals are $\tilde{u} = y -
X\tilde{\beta}$. Here we can use these residuals as a sample approximation of
the population error to obtain the GMM estimator of $\lambda$ by replacing $u$ by
$\tilde{u}$ in equation \ref{syseq}.

\subsection{Transformed model}

\subsubsection{OLS Estimator}
\subsubsection{GMM Estimator of $\lambda$}

\label{s2}
\end{document}
